# üóúÔ∏è Compressor - Optimiseur de Fichiers Multim√©dia

Une solution self-hosted compl√®te et **s√©curis√©e** pour compresser et optimiser tous vos fichiers multim√©dia tout en conservant leur format original.

![Version](https://img.shields.io/badge/version-2.0.0-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![Node](https://img.shields.io/badge/node-%3E%3D18.0.0-brightgreen.svg)
![Docker](https://img.shields.io/badge/docker-ready-blue.svg)
![Security](https://img.shields.io/badge/security-enterprise--grade-green.svg)

## üéØ Objectif

R√©duire la taille de vos fichiers multim√©dia sans changer leur format, avec une interface web moderne et un backend performant utilisant FFmpeg et Sharp, le tout avec une **s√©curit√© enterprise-grade**.

## ‚ú® Fonctionnalit√©s

### üì∏ Images
- **Formats support√©s** : JPEG, PNG, WebP, AVIF, HEIC, TIFF, BMP
- **Compression intelligente** avec pr√©servation de la qualit√©
- **Redimensionnement automatique** selon vos besoins
- **Conversion de format** optionnelle
- **Optimisation des m√©tadonn√©es** (suppression EXIF)

### üéµ Audio
- **Formats support√©s** : MP3, FLAC, WAV, AAC, OGG, M4A
- **Compression variable** (CBR/VBR)
- **Normalisation du volume** automatique
- **Conversion multi-format** simultan√©e
- **R√©duction de fr√©quence d'√©chantillonnage**

### üé¨ Vid√©o
- **Formats support√©s** : MP4, AVI, MKV, WebM, MOV, FLV
- **Codecs modernes** : H.264, H.265/HEVC, VP9, AV1
- **Compression adaptative** selon le contenu
- **Redimensionnement et recadrage** automatique
- **Optimisation pour le streaming** web

### üìÑ Documents
- **PDF** : Compression des images int√©gr√©es
- **Optimisation de la structure** du document
- **Suppression des m√©tadonn√©es** sensibles

## üîí S√©curit√© Enterprise-Grade

### üõ°Ô∏è Protection Multi-Couche
- **Path Traversal Protection** - Validation stricte des chemins de fichier
- **Magic Bytes Validation** - V√©rification des signatures de fichier
- **Upload Security** - Validation en 3 √©tapes (pr√©/pendant/post)
- **Rate Limiting Intelligent** - Protection contre les attaques DDoS
- **Content Security** - D√©tection de contenu malveillant
- **Input Sanitization** - Nettoyage de tous les inputs utilisateur

### üîê Authentification & Autorisation
- **JWT Authentication** - Tokens s√©curis√©s avec auto-expiration
- **API Key Protection** - Authentification par cl√© API
- **CORS Configuration** - Contr√¥le strict des origines
- **Headers Security** - Headers de s√©curit√© HTTP renforc√©s

### üö® Monitoring & Audit
- **Security Logging** - Enregistrement des tentatives suspectes
- **Real-time Monitoring** - Surveillance des m√©triques de s√©curit√©
- **Error Tracking** - Tra√ßabilit√© compl√®te des erreurs
- **Performance Metrics** - Monitoring des performances

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP/WebSocket    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ                 ‚îÇ
‚îÇ    Frontend     ‚îÇ                     ‚îÇ     Backend     ‚îÇ
‚îÇ   (HTML/CSS/JS) ‚îÇ                     ‚îÇ   (Node.js)     ‚îÇ
‚îÇ                 ‚îÇ                     ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                 ‚îÇ
                                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ   File Upload   ‚îÇ    ‚îÇ  Processing     ‚îÇ    ‚îÇ   FFmpeg        ‚îÇ
‚îÇ   & Validation  ‚îÇ    ‚îÇ     Queue       ‚îÇ    ‚îÇ   Sharp         ‚îÇ
‚îÇ   (S√©curis√©)    ‚îÇ    ‚îÇ   (Redis)       ‚îÇ    ‚îÇ   PDF-lib       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Installation Rapide avec Docker

### Pr√©requis
- Docker et Docker Compose install√©s
- 2GB RAM minimum
- 10GB espace disque libre

### D√©ploiement S√©curis√© en 4 √©tapes

```bash
# 1. Cloner le repository
git clone https://github.com/your-username/compressor.git
cd compressor

# 2. Configurer l'environnement s√©curis√©
cp .env.example .env

# 3. ‚úÖ IMPORTANT: G√©n√©rer des cl√©s s√©curis√©es
echo "JWT_SECRET=$(openssl rand -base64 32)" >> .env
echo "API_KEY=$(openssl rand -hex 32)" >> .env

# 4. Personnaliser la configuration
nano .env  # Modifier CORS_ORIGIN selon vos domaines

# 5. Cr√©er les dossiers et lancer
mkdir -p logs uploads
docker-compose up -d
```

**C'est tout ! üéâ**

### ‚úÖ Acc√®s √† l'application (PORTS CORRIG√âS)
- **Interface Web** : http://localhost:3001
- **API Backend** : http://localhost:8081  ‚¨ÖÔ∏è **PORT CORRIG√â**
- **Health Check** : http://localhost:8081/api/health
- **API Documentation** : http://localhost:8081/docs

## üîß Configuration S√©curis√©e

### Variables d'environnement essentielles

```env
# ‚úÖ S√©curit√© (OBLIGATOIRE √† changer)
JWT_SECRET=$(openssl rand -base64 32)     # Auto-g√©n√©r√© s√©curis√©
API_KEY=$(openssl rand -hex 32)           # Cl√© API s√©curis√©e
AUTH_ENABLED=true                         # Activer en production

# ‚úÖ CORS (URLs autoris√©es - IMPORTANT)
CORS_ORIGIN=https://compressor.yourdomain.com

# ‚úÖ Stockage s√©curis√©
UPLOADS_PATH=/data/compressor/uploads     # Chemin absolu recommand√©
LOGS_PATH=/var/log/compressor            # S√©paration des logs

# ‚úÖ S√©curit√© avanc√©e
STRICT_MIME_VALIDATION=true              # Validation MIME stricte
MAGIC_BYTES_VALIDATION=true              # V√©rification signatures
DDOS_PROTECTION=true                     # Protection DDoS
MAX_REQUESTS_PER_SECOND=10               # Limite requ√™tes/sec
```

### Param√®tres de compression par d√©faut

```json
{
  "images": {
    "quality": 80,
    "maxWidth": 1920,
    "maxHeight": 1080,
    "format": "auto",
    "removeMetadata": true
  },
  "videos": {
    "codec": "h264",
    "crf": 23,
    "preset": "medium"
  },
  "audio": {
    "codec": "aac",
    "bitrate": "128k",
    "sampleRate": 44100
  }
}
```

## üìä Performances

### Performances typiques

| Type de fichier | Taille max | Temps de traitement | Compression moyenne | S√©curit√© |
|-----------------|------------|--------------------|--------------------|----------|
| **Image JPEG**  | 50 MB      | 2-5 secondes       | 30-70%            | ‚úÖ Valid√©e |
| **Vid√©o HD**    | 2 GB       | 2-10 minutes       | 40-80%            | ‚úÖ Valid√©e |
| **Audio FLAC**  | 200 MB     | 10-30 secondes     | 50-90%            | ‚úÖ Valid√©e |
| **PDF**         | 100 MB     | 5-15 secondes      | 10-60%            | ‚úÖ Valid√©e |

### Stack Compressor (PORTS CORRIG√âS)

| Service | Port | R√¥le | S√©curit√© |
|---------|------|------|----------|
| **compressor-frontend** | 3001 | Interface utilisateur | ‚úÖ Headers s√©curis√©s |
| **compressor-app** | 8081 | API REST + WebSocket | ‚úÖ Auth + Validation |
| **compressor-worker** | - | Traitement fichiers | ‚úÖ Isolation sandbox |
| **compressor-redis** | - | Queue + Cache | ‚úÖ R√©seau interne |

## üõ†Ô∏è Utilisation

### Interface Web S√©curis√©e
1. **Authentifiez-vous** avec votre cl√© API (si activ√©e)
2. **Glissez-d√©posez** vos fichiers dans la zone d'upload s√©curis√©e
3. **Validation automatique** - V√©rification des signatures et types
4. **Ajustez** les param√®tres de compression (optionnel)
5. **Suivez** la progression en temps r√©el via WebSocket
6. **T√©l√©chargez** vos fichiers optimis√©s de mani√®re s√©curis√©e

### API REST S√©curis√©e

#### Upload s√©curis√© d'un fichier
```bash
# Avec authentification
curl -X POST http://localhost:8081/api/upload \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -F "file=@image.jpg" \
  -F 'settings={"quality":85,"maxWidth":1920}'

# Sans authentification (si AUTH_ENABLED=false)
curl -X POST http://localhost:8081/api/upload \
  -F "file=@image.jpg" \
  -F 'settings={"quality":85,"maxWidth":1920}'
```

#### R√©cup√©rer le statut
```bash
curl -H "Authorization: Bearer YOUR_API_KEY" \
     http://localhost:8081/api/status/job-id
```

#### T√©l√©charger le r√©sultat s√©curis√©
```bash
curl -H "Authorization: Bearer YOUR_API_KEY" \
     http://localhost:8081/api/download/job-id -o optimized-image.jpg
```

### WebSocket Temps R√©el S√©curis√©
```javascript
const socket = io('http://localhost:8081', {
    auth: {
        token: 'YOUR_API_KEY'  // Si authentification activ√©e
    }
});

socket.on('job-progress', (data) => {
    console.log(`Job ${data.jobId}: ${data.progress}%`);
});

socket.on('job-completed', (data) => {
    console.log(`Job termin√©: ${data.compressionRatio}% de compression`);
});
```

## üîç Monitoring et Logs

### Commandes utiles

```bash
# Voir l'√©tat de la stack
docker-compose ps

# Logs en temps r√©el
docker-compose logs -f

# Logs de s√©curit√© sp√©cifiques
docker-compose logs -f | grep SECURITY

# Stats de performance
docker stats compressor-app compressor-worker

# Health check avec authentification
curl -H "Authorization: Bearer YOUR_API_KEY" \
     http://localhost:8081/api/health

# Health check d√©taill√©
curl http://localhost:8081/api/health/detailed?includeMetrics=true
```

### M√©triques de s√©curit√© disponibles
- **Tentatives d'authentification** √©chou√©es
- **Rate limiting** d√©clench√©
- **Fichiers suspects** rejet√©s
- **Path traversal** tent√©
- **Magic bytes** invalides
- **Upload malveillants** bloqu√©s

## üîí S√©curit√© Avanc√©e

### Mesures impl√©ment√©es
- **Triple validation** des uploads (pr√©/pendant/post-multer)
- **Magic bytes verification** stricte
- **Path traversal protection** compl√®te
- **Rate limiting intelligent** par IP et taille
- **Content-Type validation** avec boundary
- **User-Agent filtering** anti-bot
- **JWT authentication** avec expiration
- **CORS strict** configur√© par domaine
- **Headers security** (CSP, HSTS, etc.)
- **Input sanitization** sur tous les champs
- **Error handling** sans leak d'informations
- **Audit logging** complet

### Configuration de production recommand√©e

```env
# S√©curit√© maximale
AUTH_ENABLED=true
STRICT_MIME_VALIDATION=true
MAGIC_BYTES_VALIDATION=true
DDOS_PROTECTION=true
RATE_LIMIT=100
UPLOAD_RATE_LIMIT=10
MAX_REQUESTS_PER_SECOND=5

# HTTPS obligatoire
HTTPS_ENABLED=true
FORCE_HTTPS=true
CORS_ORIGIN=https://yourdomain.com

# Monitoring renforc√©
LOG_LEVEL=warn
METRICS_ENABLED=true
SENTRY_DSN=your_sentry_dsn
```

### Checklist de s√©curit√©

- [ ] ‚úÖ JWT_SECRET g√©n√©r√© avec `openssl rand -base64 32`
- [ ] ‚úÖ API_KEY g√©n√©r√© avec `openssl rand -hex 32`
- [ ] ‚úÖ AUTH_ENABLED=true en production
- [ ] ‚úÖ CORS_ORIGIN configur√© avec vos domaines r√©els
- [ ] ‚úÖ HTTPS_ENABLED=true avec certificats valides
- [ ] ‚úÖ Firewall configur√© (ports 22, 80, 443 uniquement)
- [ ] ‚úÖ Logs de s√©curit√© monitored
- [ ] ‚úÖ Sauvegardes automatiques configur√©es
- [ ] ‚úÖ Rate limiting ajust√© selon votre trafic
- [ ] ‚úÖ Worker isolation v√©rifi√©e

## üõ†Ô∏è Maintenance

### Backup s√©curis√©
```bash
# Sauvegarder les donn√©es avec chiffrement
docker run --rm \
  -v compressor_uploads:/data \
  -v $(pwd):/backup \
  alpine sh -c "tar czf - /data | openssl enc -aes-256-cbc -out /backup/compressor-backup-$(date +%Y%m%d).tar.gz.enc -k YOUR_BACKUP_PASSWORD"
```

### Mise √† jour s√©curis√©e
```bash
# Sauvegarde avant mise √† jour
./backup.sh

# Arr√™ter, mettre √† jour et red√©marrer
docker-compose down
git pull origin main
docker-compose build --no-cache
docker-compose up -d

# V√©rifier la s√©curit√©
curl http://localhost:8081/api/health/detailed
```

### Audit de s√©curit√©
```bash
# Analyser les logs de s√©curit√© des 24 derni√®res heures
docker-compose logs --since 24h | grep -E "(SECURITY|ERROR|WARN)" > security-audit.log

# V√©rifier les tentatives d'intrusion
grep "path traversal\|magic bytes\|suspicious" security-audit.log

# Statistiques des rejets
grep -c "rejected\|blocked\|denied" security-audit.log
```

## üêõ D√©pannage

### Probl√®mes de s√©curit√© courants

#### Authentification √©choue
```bash
# V√©rifier la configuration JWT
echo $JWT_SECRET | base64 -d | wc -c  # Doit √™tre >= 32

# Tester l'authentification
curl -H "Authorization: Bearer $API_KEY" http://localhost:8081/api/health
```

#### CORS bloqu√©
```bash
# V√©rifier la configuration CORS
echo $CORS_ORIGIN

# Tester depuis le navigateur
curl -H "Origin: https://yourdomain.com" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS http://localhost:8081/api/upload
```

#### Upload rejet√© pour s√©curit√©
```bash
# Voir les logs de rejet
docker-compose logs compressor-app | grep "SECURITY.*rejected"

# V√©rifier la signature du fichier
file your-file.jpg
hexdump -C your-file.jpg | head -n 3
```

#### Rate limiting activ√©
```bash
# Voir les stats de rate limiting
curl http://localhost:8081/api/health/metrics | jq '.rateLimit'

# Ajuster les limites si n√©cessaire
# Modifier RATE_LIMIT et UPLOAD_RATE_LIMIT dans .env
```

## üöÄ D√©ploiement Production S√©curis√©

### Configuration serveur de production

```bash
# 1. G√©n√©rer des cl√©s s√©curis√©es
JWT_SECRET=$(openssl rand -base64 32)
API_KEY=$(openssl rand -hex 32)

# 2. Configuration production s√©curis√©e
cat > .env